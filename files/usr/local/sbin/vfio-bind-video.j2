#!/bin/bash

#
# The file binds {{ item.value['name'] }} to vfio-pci module so that it
# can be passed to virtual machines.
#

touch "/run/vfio-bind-video-{{ item.key }}.lock"

{% for address in item.value['address'] %}
echo "{{ address['vendor'] }} {{ address['model'] }}" > /sys/bus/pci/drivers/vfio-pci/new_id
echo "{{ address|pciaddr('pciutils') }}" > /sys/bus/pci/devices/{{ address|pciaddr('pciutils') }}/driver/unbind
echo "{{ address|pciaddr('pciutils') }}" > /sys/bus/pci/drivers/vfio-pci/bind
echo "{{ address['vendor'] }} {{ address['model'] }}" > /sys/bus/pci/drivers/vfio-pci/remove_id

{% endfor %}

