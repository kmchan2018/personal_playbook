

- hosts: "all"
  become: true
  become_user: "root"

  tasks:

    - name: "Setup Website test.kmchan3.space"
      when: "website_test_kmchan3_space_enabled|default(false)"
      block:

        - name: "Setup Website test.kmchan3.space: Create Group"
          group:
            name: "www-test"
            system: "yes"
            state: "present"

        - name: "Setup Website test.kmchan3.space: Create User"
          user:
            name: "www-test"
            group: "www-test"
            home: "/var/www/test.kmchan3.space"
            password: "!"
            shell: "/bin/bash"
            create_home: "yes"
            move_home: "no"
            system: "yes"
            state: "present"

        - name: "Setup Website test.kmchan3.space: Create Directories"
          file:
            dest: "{{ item.name }}"
            state: "directory"
            owner: "{{ item.owner|default('root') }}"
            group: "{{ item.group|default('root') }}"
            mode: "{{ item.mode|default('0755') }}"
          loop:
            - { name: "/var/log/websites", owner: "root", group: "root", mode: "0755" }
            - { name: "/var/log/websites/test.kmchan3.space", owner: "www-test", group: "www-test", mode: "0750" }
            - { name: "/var/www/test.kmchan3.space", owner: "www-test", group: "www-test", mode: "0755" }
            - { name: "/var/www/test.kmchan3.space/html", owner: "www-test", group: "www-data", mode: "0755" }
            - { name: "/var/www/test.kmchan3.space/html/.well-known", owner: "www-test", group: "www-data", mode: "0755" }
            - { name: "/var/www/test.kmchan3.space/projects", owner: "www-test", group: "www-test", mode: "0755" }

        - name: "Setup Website test.kmchan3.space: Install Configuration Files"
          template:
            dest: "{{ item.path }}"
            src: "files/{{ item.path }}.j2"
            owner: "{{ item.owner|default('root') }}"
            group: "{{ item.group|default('root') }}"
            mode: "{{ item.mode|default('0644') }}"
          loop:
            - { path: "/etc/apache2/sites-available/001-test.kmchan3.space.conf" }
            - { path: "/etc/logrotate.d/test.kmchan3.space" }
            - { path: "/etc/sudoers.d/test.kmchan3.space", mode: "0600" }
            - { path: "{{ php_config_path }}/fpm/pool.d/test.kmchan3.space.conf" }

        - name: "Setup Website test.kmchan3.space: Enable Site"
          shell: "a2ensite 001-test.kmchan3.space"


